#               ,@\.                               I Love Illya Forever!                                               
#             ,@\o@^                                                                                  .]].             
#            =@/oo/@.                             ..]]]]]]]]]]]]]]]]`...                            .@\o/@`            
#           =@/oo/.@`                     .]]@/[[........................,[[@@]]`.                  //oooo/@.          
#          ,@\oo/..=\               .]/@[..........................................[\\].           ,@/..ooo/@.         
#          =@ooo^...@^          .]@[........*.........................................,@@@\`       =^....OOo\^         
#          @^o/[^...=\       .//`......]@[...................................................[@].  =^.......=@.        
#          @^/.......@.    ,@`......,@`........................................................*.[@/^........@.        
#          ,@^.......=\  ,@^...`..,@`................]O]..........................................*.\`.......@.        
#           ,@`.......@./@O^/[...=/.............*.,O@@OO@`......................,\......].....,@`...*,@`....=^         
#.]]`..       \\......=@@O@@.*..//.............../@@@@@@@............*.\.......*..\`.....\\......\\..*.\^..=/          
#\^oo/..[[\@]]`.[@`...=@@@OO^.=@/..............,@/Oooo.=@.......,.....*.@`......*..@.....*,@.....*.@`.*.@\@` .,]]]@@@@@
#.@\ooo]........,[@@\`.@OOOOO/@@.......*......=@\OO/..,]@]].....@........@.........\^......,@...\`..\^..,@/[`....../o/@
#  ,@\\^..............@@OOOOOO@........=^....=@/OO,/`...@^......@........=^.......,/@@@]]...\@\..,\..\^..\\......[o//@`
#    .,[@\]]....,]]/@@@@OOOOO@`.......=^..*./@oO^.......=@.**...=^........@ ......./^....,[.=@OO..,^..@`.=@.....,/@[.  
#      ,@[[`,/OOO@/\@OOOO@@O@^........@....=@/O`.@..@.=^,@@`.....@......./@..****. @O`.....,@/@OO^.\`.=\..@@@@OO@\`    
#    .@`../OOOO@/ .@O@OOOOOO@........=/....@oO]@@@@@@@@@@@@@O]...,\..../O@@`.....,@@O^.*]/O@`,o@OO^=^.=@..=@OOO@`.,@`  
#   ,@...@OOOO/.  =@OO@OOOO@^........=^...=@/@@@@@@@@@@@@@@/@@OO\`,\/OOO@@O^..]OO@@@OOOO@@@@\@,\@OO`@./@..=@@OOOO\..=\ 
#   @^../OOO@`    =@OOOO@@@@.........=^.*.=\//[....@@@@@\...,O@@OOOO@O@@\@OOOOO@/=OO@@@@@@@@@@@@\@OO@O@^..=/ ,@OOO@..\^
#   @^.,@OO@.     =@^=OO@,O@......*`.=@.*.@O...... @@@@@@......[O@@@/`..O\@O@/`..........@@@@/@/@@O@O@@`*.=^  .\@O@^.=@
#   =@.,@O@^      ,@`.\@`o@^......=O^.@`*.@^..=@..,@@@@@@............................@...@@@@@..=O@@@O/...=^    =@@^.=^
#    ,@`=@@.       @..=@,o@^......=@O\,@..@^..=@@\/@@@@@@...........................=@`,`@@@@@....@@@O....=^    .@@`=/ 
#      ,\@@.       @..,@.\@^.......\@@O`\`=\..=@@@@@@@@@@...........................=@@@@@@@@@^...@@/.....=^     =\@`  
#                  @...\@o@^........OOO@@`\@`.,@@@@@@\,@^...........................=@@O@O@@@@....@@`...]`=^           
#                 =/.=^=O@@^....=^...OO@OoO[...\^=@@@\/@`............................@@@@@^=@^....=^..,O@^=^           
#                ,@..=^=OO@^....=\....\@@^.......,`,[..,`............................=^,@\@@@..../^,/OO@/..\           
#               //...=^=OO@@,]`..@.....=@OOooooooOO`............................................[@@@@OO`...@`          
#             ,@`*...@./OOO@/.\\.=^.....\\O,[\o/[`.............@@@@@@@@@@@@@\`............,OOOOOOOO^@OO....=^          
#            =/,/@@@@@/OO@/...O@..@`.....@/O\...................,@@OOOOOOO@@`..............,\OOOOO`/@OO...*.@.         
#           .@[./@/\/@\],@`./@@/[@.@....*.@@@@OOo]`...................`.........................,/@@OOO...*.@^         
#   ./@@@@\]@./^=^.,@@[\@\,@/.../@..@`...*.\@@@@@@@@@@@OO\]]..............................,]/@@@@@@@OOO.@.*.@^         
#    ,@\`..=@.@//`]`,`*@@@^=@@@@@OO`.=\...*.=\=ooooo]o\@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[`@\ooo/@@@@@@@OO/.@.*.@^         
#      .O@@@@^\@\@O*,@@@@@^.@]]/@@@OO`.\`..*.=@@@@@\,[oooo\/\@O\OOOOO[@@/o\oooo[@OOO/,@\OOOo@@@@@@@OOO^=^..=^          
#     .\\]]]]@\,\@\/@OOO@`,@OOOO@@OOOOO\,@....\@..=/@`.....,[[\/@OO@@\/ooo[`/@@@@\@\@//Ooo\@@@@@@@@OOO,@../^           
#         ../^.\@\]]`.,]/@@OOOOOOO@@OOOOO`\`*./@/@.,@@\....,]@@@@^.*=@\]....@\...=\\@oOo\@@@@@@@@@OO/,@`//.            
#           \@@[       =@@@@@O@/\@@//\@OOOO^,O@@@\@OoOOO@Ooooo\@/[/[\\/OO@@@@/O@@@\o\\@@[@OO@@@@OOO\@@@`               
#                       ,@@@@`./^.....,/@@@O@@\@@@Ooooo\@=///`.,O**.\`,\@@oo\@@@@@Oooo\@`=@@@OOO@@[.                   
#                        .\@@@@`.....]ooo\\@@`@@OOooooo=@\\@\]OOO^**.=@\]@OoO@`\@@OO///./`,@/`.                        
#                         @[[@.]]]Ooo/o]@@@\`@@OOOooooo@^oooooOOOO@@OOO/@\ooO@\@\@@@[]@[....@`                         
#                         =\..[@@@@@[o][\/@@@@OOOoOOOoo\\oooooooooooooo=@oooO@@\@@@[\o]......\\]`                      
#                          .\@@@@@@,\@@OOOooooooooOO@@@@@Ooooooooooooo\@OOOOO@@@\o\/[@@@]O\..]]/@`                     
#                           =@O]@/,[]/\oooooOOOO@@@OOooooo/OoOoo@ooOOOOoo\/@@Oooo/O@@]^\`.[@@^                         
#                          =@OO@@@@\/@@@@@@OOO\/@\oooooooooooo\@@\oooooooooo/@@Oooooo\O@O@`                            
#                         .@OOOO@@/[@@@@@@@....@^oooooooooo/\@//.@\\ooooooooo^@^/O@@@@@@@@O].                          
#                     =/[\/@@[`       ,@@@@\]]]/@/oooooo\@@/\/....,@@/oooooooo/@.@@@@@@@@OOOOO`                        
#                    ,@[]`@/.            .@@@@@@@@@@@@@@]]O@@`.....].\]/[@@@@/[]@@@@@/[[[[[[[..                        
#                      . [/`              .@OO@\/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`.                                   
#                                         .\@[[\@OOO@O@@@@/[//[@/[\@@@@/@@/\@O@.                                       
#                                                .\@OOOOO@@OO@\     ,@O@@OO@@OO@@\@                                    
#                                                   ,[\[[[`.          .[\@OOOOO@^/^                                    
#                                                                         ,@]]@@O@^                                    
'Full-automatic FGO Script'
__author__='hgjazhgj'
import time,os,re,numpy,cv2,win32con,win32ui,win32gui,win32api,win32console,win32print,win32process,winsound
hConWnd=win32console.GetConsoleWindow()
hDesktopWnd=win32gui.GetDesktopWindow()
hQtWnd=0
hPreFgoWnd=win32gui.FindWindow(None,'BlueStacks App Player')
hFgoWnd=win32gui.FindWindowEx(hPreFgoWnd,None,None,None)
tapOffset=(0,0)
androidScale=1
def setAndroid():
    global tapOffset,androidScale
    with os.popen(adbPath+' shell wm size')as p:tapOffset,androidScale=(lambda size:((0,round(960*size[0]/size[1])-540),1920/size[1])if size[1]*1080<size[0]*1920else((round(540*size[1]/size[0])-960,0),1080/size[0]))(sorted((lambda x:[int(i)for i in x])(re.search('[0-9]{1,}x[0-9]{1,}',p.read()).group().split('x'))))
screenSize,winScale=(lambda hDC:(lambda x:((x,win32print.GetDeviceCaps(hDC,win32con.DESKTOPVERTRES)),x/win32print.GetDeviceCaps(hDC,win32con.HORZRES),win32gui.ReleaseDC(None,hDC))[:-1])(win32print.GetDeviceCaps(hDC,win32con.DESKTOPHORZRES)))(win32gui.GetDC(0))
IMG_APEMPTY=cv2.imread('image/apempty.png')
IMG_ATTACK=cv2.imread('image/attack.png')
IMG_BEGIN=cv2.imread('image/begin.png')
IMG_BOUND=cv2.imread('image/bound.png')
IMG_BOUNDUP=cv2.imread('image/boundup.png')
IMG_CARDSEALED=cv2.imread('image/cardsealed.png')
IMG_CHOOSEFRIEND=cv2.imread('image/choosefriend.png')
IMG_END=cv2.imread('image/end.png')
IMG_FAILED=cv2.imread('image/failed.png')
IMG_FRIEND=[[file[:-4],cv2.imread('image/friend/'+file)]for file in os.listdir('image/friend')if file.endswith('.png')]
IMG_HOUGUSEALED=cv2.imread('image/hougusealed.png')
IMG_NOFRIEND=cv2.imread('image/nofriend.png')
IMG_STILL=cv2.imread('image/still.png')
IMG_STAGE=[cv2.imread('image/stage/'+file)for file in os.listdir('image/stage')if file.startswith('stage')and file.endswith('.png')]
skillInfo=[[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]]]#minstage,minstageturn,obj
houguInfo=[[1,1],[1,1],[1,1],[1,1],[1,1],[1,1]]#minstage,priority
friendPos=4
dangerPos=[0,0,1]
terminateFlag=False
suspendFlag=False
key={'\x09':(1800,304),'\x12':(960,943),#tab VK_TAB #alt VK_MENU
' ':(1820,1030),'1':(277,640),'2':(648,640),'3':(974,640),'4':(1262,640),'5':(1651,640),'6':(646,304),'7':(976,304),'8':(1267,304),
'A':(109,860),'B':(1680,368),'C':(845,540),'D':(385,860),'E':(1493,470),'F':(582,860),'G':(724,860),'H':(861,860),'J':(1056,860),'K':(1201,860),
'L':(1336,860),'N':(248,1041),'P':(1854,69),'Q':(1800,475),'R':(1626,475),'S':(244,860),'V':(1105,540),'W':(1360,475),'X':(259,932),
'\x64':(70,221),'\x65':(427,221),'\x66':(791,221),'\x67':(70,69),'\x68':(427,69),'\x69':(791,69),#NUM4 #NUM5 #NUM6 #NUM7 #NUM8 #NUM9
'\xA0':(41,197),'\xA1':(41,197),'\xBA':(1247,197)}# VK_LSHIFT # VK_RSHIFT #; VK_OEM_1
def getTime():return time.strftime('%Y-%m-%d_%H.%M.%S',time.localtime())
def printer(*args,**kwargs):print(getTime(),*args,**kwargs)
def beep():winsound.PlaySound('SystemHand',0)
def show(img):cv2.imshow('imshow',img),cv2.waitKey(),cv2.destroyAllWindows()
def windowCapture(hWnd):return(lambda hWnd:(lambda width,height:(lambda hWndDC:(lambda mfcDC:(lambda memDC,bitMap:(bitMap.CreateCompatibleBitmap(mfcDC,width,height),memDC.SelectObject(bitMap),memDC.BitBlt((0, 0),(width,height),mfcDC,(0,0),win32con.SRCCOPY),numpy.frombuffer(bitMap.GetBitmapBits(True),dtype='uint8').reshape(height,width,4)[:,:,0:3],win32gui.DeleteObject(bitMap.GetHandle()),memDC.DeleteDC(),mfcDC.DeleteDC(),win32gui.ReleaseDC(hWnd,hWndDC))[3])(mfcDC.CreateCompatibleDC(),win32ui.CreateBitmap()))(win32ui.CreateDCFromHandle(hWndDC)))(win32gui.GetDC(hWnd)))(*[int(i*winScale+.001)for i in win32gui.GetClientRect(hWnd)[2:]]))(hWnd if hWnd else hDesktopWnd)
def setForeground(hWnd):
    try:(lambda dwForeID,dwCurrID:(win32process.AttachThreadInput(dwCurrID,dwForeID,True),win32gui.ShowWindow(hWnd,win32con.SW_SHOWNORMAL),win32gui.SetForegroundWindow(hWnd),win32process.AttachThreadInput(dwCurrID,dwForeID,False)))(win32process.GetWindowThreadProcessId(win32gui.GetForegroundWindow())[0],win32api.GetCurrentThreadId())
    except:pass
def playSound(file='sound/default.wav',flag=winsound.SND_LOOP|winsound.SND_ASYNC):winsound.PlaySound(file,flag),os.system('pause'),winsound.PlaySound(None,0)
#def rgb2hsv(x):return(lambda R,G,B:(lambda cmax:(lambda delta:(0if delta==0else int(((G-B)/delta if R==cmax else(B-R)/delta+2if G==cmax else(R-G)/delta+4)*60)%360,0if cmax==0else int(100*delta/cmax),int(cmax*100/255)))(cmax-min(R,G,B)))(max(R,G,B)))(*(lambda x:[int(i)for i in x])(x[2::-1]))#R,G,B:[0,255]/H:[0,359]/S,V:[0,100]
def tap(x,y):os.system(adbPath+' shell input tap {} {}'.format(*[round(i*androidScale)for i in[x+tapOffset[0],y+tapOffset[1]]]))
def swipe(rect,interval=500):os.system(adbPath+' shell input swipe {} {} {} {} {}'.format(*[round(i*androidScale)for i in[rect[0]+tapOffset[0],rect[1]+tapOffset[1],rect[2]+tapOffset[0],rect[3]+tapOffset[1]]],interval))
#def screenShot(name=''):os.system(adbPath+'exec-out screencap -p > {name}'.format(name=name if name!=''else getTime()+'.png')))
def press(c):tap(*key[c])
def doit(touch,wait):[(press(i),time.sleep(j*.001))for i,j in zip(touch,wait)]
class Fuse:
    def __init__(self,fv=300):
        self.__value=0
        self.__max=fv
    @property
    def value():return self.__value
    def increase(self):
        self.__value+=1
        if self.__value>self.__max:
            printer('Fused')
            beep()
            exit(0)
    def reset(self):
        self.__value=0
        return True
    def show(self):printer(self.__value,'/',self.__max,sep='',flush=True)
fuse=Fuse()
class Check:
    def __init__(self,lagency=.08,img=None):
        global suspendFlag
        if suspendFlag:
            setForeground(hConWnd)
            os.system('pause')
            suspendFlag=False
            if win32gui.IsWindow(hQtWnd):
                setForeground(hQtWnd)
        if terminateFlag:
            exit(0)
        fuse.increase()
        time.sleep(lagency)
        self.im=(lambda im:im[im.shape[0]//2-540:im.shape[0]//2+540,im.shape[1]//2-960:im.shape[1]//2+960])((lambda img:(lambda scale:cv2.resize(img,(0,0),None,scale,scale,cv2.INTER_CUBIC))(max(1920/img.shape[1],1080/img.shape[0])))(windowCapture(hFgoWnd)if img is None else img))
    def compare(self,img,rect=(0,0,1920,1080),delta=.03):return cv2.minMaxLoc(cv2.matchTemplate(self.im[rect[1]:rect[3],rect[0]:rect[2]],img,cv2.TM_SQDIFF_NORMED))[0]<delta
    def select(self,img,rect=(0,0,1920,1080)):return(lambda x:x.index(min(x)))([cv2.minMaxLoc(cv2.matchTemplate(self.im[rect[1]:rect[3],rect[0]:rect[2]],i,cv2.TM_SQDIFF_NORMED))[0]for i in img])
    def tapOnCmp(self,img,rect=(0,0,1920,1080),delta=.03):return(lambda loc:loc[0]<delta and(tap(rect[0]+loc[2][0]+img.shape[1]//2,rect[1]+loc[2][1]+img.shape[0]//2),time.sleep(.5),fuse.reset())[2])(cv2.minMaxLoc(cv2.matchTemplate(self.im[rect[1]:rect[3],rect[0]:rect[2]],img,cv2.TM_SQDIFF_NORMED)))
    def save(self,name=''):cv2.imwrite('ScreenShots/'+(getTime()+'.png'if name==''else name),self.im);return self
    def show(self):show(cv2.resize(self.im,(800,450)));return self
    def isTurnBegin(self):return self.compare(IMG_ATTACK,(1567,932,1835,1064))and fuse.reset()
    def isBattleOver(self):return(self.compare(IMG_BOUND,(95,235,460,318))or self.compare(IMG_BOUNDUP,(978,517,1491,596),.06))and fuse.reset()
    def isBegin(self):return self.compare(IMG_BEGIN,(1630,950,1919,1079))and fuse.reset()
    def isHouguReady(self):return(lambda im:[not any([self.compare(j,(470+346*i,258,768+346*i,387),.3)for j in(IMG_HOUGUSEALED,IMG_CARDSEALED)])and(numpy.mean(self.im[1014:1021,217+480*i:235+480*i])>90or numpy.mean(im[1014:1021,217+480*i:235+480*i])>90)for i in range(3)])(Check(.8).im)
    def isSkillReady(self):return[[not self.compare(IMG_STILL,(65+480*i+141*j,895,107+480*i+141*j,927),.06)for j in range(3)]for i in range(3)]
    def isApEmpty(self):return self.compare(IMG_APEMPTY,(800,50,1120,146))and fuse.reset()
    def isChooseFriend(self):return self.compare(IMG_CHOOSEFRIEND,(1628,314,1772,390))and fuse.reset()
    def isNoFriend(self):return self.compare(IMG_NOFRIEND,(369,545,1552,797),.1)and fuse.reset()
    def getABQ(self):return[-1if self.compare(IMG_CARDSEALED,(43+386*i,667,345+386*i,845),.3)else(lambda x:x.index(max(x)))([numpy.mean(self.im[771:919,108+386*i:318+386*i,j])for j in(2,1,0)])for i in range(5)]
    def getStage(self):return self.select(IMG_STAGE,(1290,14,1348,60))+1
    def getPortrait(self):return[self.im[640:740,195+480*i:296+480*i]for i in range(3)]
def draw():
    while True:press('2')
def chooseFriend():
    if len(IMG_FRIEND)==0:
        doit('8',(1000,))
        return
    while True:
        for i in range(6):
            chk=Check(.2)
            for name,img in IMG_FRIEND:
                if chk.tapOnCmp(img,delta=.015):
                    printer('  Friend :',name)
                    try:
                        skillInfo[friendPos]={
                            'km':[[2,0,1],[1,0,0],[1,0,0]],
                            'cba':[[3,0,2],[3,0,0],[1,0,1]],
                            'ml':[[1,0,0],[1,0,0],[3,0,1]],
                        }[name[:name.index('_')]]
                    except(KeyError,ValueError):
                        skillInfo[friendPos]=[[4,0,0],[4,0,0],[4,0,0]]
                    time.sleep(1)
                    return
            swipe((220,960,220,557))
        doit('\xBAJ',(500,1000))
        while True:
            chk=Check(.2)
            if chk.isNoFriend():
                printer('No Friend')
                exit(0)
            if chk.isChooseFriend():break
def oneBattle():
    turn,stage,stageTurn,servant=0,0,0,[0,1,2]
    while True:
        chk=Check(.2)
        if chk.isTurnBegin():
            turn,stage,stageTurn,skill,newPortrait=[turn+1]+(lambda chk:(lambda x:[x,stageTurn+1if stage==x else 1])(chk.getStage())+[chk.isSkillReady(),chk.getPortrait()])(Check(.3))
            if stageTurn==1:doit('\x69\x68\x67\x66\x65\x64'[dangerPos[stage-1]]+'P',(50,500))
            if turn>1:servant=(lambda m,p:[m+p.index(i)+1if i in p else servant[i]for i in range(3)])(max(servant),[i for i in range(3)if servant[i]<6and cv2.matchTemplate(newPortrait[i],portrait[i],cv2.TM_SQDIFF_NORMED)[0][0]>=.03])
            portrait=newPortrait
            printer('   ',turn,stage,stageTurn,servant)
            for i,j in[(i,j)for i in range(3)if servant[i]<6for j in range(3)if skill[i][j]and stage<<8|stageTurn>=skillInfo[servant[i]][j][0]<<8|skillInfo[servant[i]][j][1]]:
                doit((('A','S','D'),('F','G','H'),('J','K','L'))[i][j],(300,))
                if skillInfo[servant[i]][j][2]!=0:doit(chr(skillInfo[servant[i]][j][2]+49),(300,))
                time.sleep(2)
                while not Check(.2).isTurnBegin():pass
            doit(' ',(2250,))
            doit((lambda chk:(lambda c,h:([chr(i+54)for pri in{houguInfo[i][1]for i in servant if i<6}for i in range(3)if h[i]and houguInfo[servant[i]][1]==pri]if any(h)else[chr(j+49)for i in range(3)if c.count(i)>=3for j in range(5)if c[j]==i])+[chr(j+49)for i in(0,2,1,-1)for j in range(5)if c[j]==i])(chk.getABQ(),(lambda h:[h[i]and stage>=houguInfo[servant[i]][0]for i in range(3)])(chk.isHouguReady())))(Check())[:3],(100,100,10000))
        elif chk.isBattleOver():
            printer('  Battle Finished')
            break
        elif chk.tapOnCmp(IMG_FAILED,rect=(277,406,712,553)):
            printer('  Battle Failed')
            beep()
            return False
    return True
def main(appleCount=0,appleKind=0,battleFunc=oneBattle,*args,**kwargs):
    apple=0
    battle=0
    while True:
        battle+=1
        doit('8',(1000,))
        if Check().isApEmpty():
            if apple==appleCount:
                printer('Ap Empty')
                press('\x12')
                return
            else:
                apple+=1
                printer('Apple',apple)
                doit('W4K8'[appleKind]+'L',(400,1200))
        printer('  Battle',battle)
        flush=True
        while True:
            chk=Check(.2)
            if chk.isNoFriend():
                if flush:
                    doit('\xBAJ',(500,1000))
                    flush=False
                else:
                    printer('No Friend')
                    exit(0)
            if chk.isChooseFriend():break
        chooseFriend()
        doit(' ',(1000,))
        if not battleFunc(*args,**kwargs):doit('VJ',(500,500))
        doit('    ',(200,200,200,200))
        while True:
            chk=Check()
            if chk.isBegin():break
            chk.tapOnCmp(IMG_END,rect=(243,863,745,982))
            doit(' ',(300,))
